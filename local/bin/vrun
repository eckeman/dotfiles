#!/usr/bin/env bash
if [ ! -f "${PWD}/Vagrantfile" ]; then
	echo 'Error: No Vagrantfile in current directory'
	exit 1
fi

cmd="cd /vagrant; $@"
ssh_config_cache="${PWD}/.vagrant-ssh-config"

if [ ! -f "$ssh_config_cache" ]; then
	vagrant ssh-config > "$ssh_config_cache"
fi

if [ $? -eq 1 ]; then
	echo
	exit_code=255
else
	ssh -t -t -q -F $ssh_config_cache default "$cmd"
	exit_code=$?
fi

if [ $exit_code -eq 255 ]; then
	echo 'Error: Could not connect to vagrant'
	rm "$ssh_config_cache"

	read -n 1 -p "Do you want to start vagrant and retry? [Y/n] " choice
	case $choice in
		[Yy]* )
			echo
			vagrant up && vrun "$cmd"
			;;
		* )
			echo
			exit $exit_code
			;;
	esac
else
	exit $exit_code
fi
