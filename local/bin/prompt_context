#!/usr/local/bin/fish

function __prompt_context_pwd
  set -l short_pwd
  set -l git_pwd (git rev-parse --show-toplevel ^/dev/null)

  if test -z "$git_pwd"
    set short_pwd (echo $PWD | sed -e "s|^$HOME|~|")
  else
    set -l git_project (basename $git_pwd)
    set short_pwd (echo $PWD | sed -e "s|^$git_pwd|$git_project|")
  end

  set_strong_color
  echo -n $short_pwd
  set_normal_color
end

function __prompt_context_git
  set -l branch (git symbolic-ref --short --quiet HEAD ^/dev/null)
  test -z $branch; and return

  echo -n ' on '

  if git diff --quiet --ignore-submodules HEAD ^/dev/null
    set_subtle_color
  else
    set_strong_color
  end

  echo -n $branch

  set -l unmerged (git cherry -v @\{upstream\} ^/dev/null)
  if not test -z "$unmerged"
    echo -n '‚ü≥'
  end

  set_normal_color
end

function __prompt_context
  echo -n ' '
  __prompt_context_pwd
  __prompt_context_git
end

if test -z "$TMUX"
  function set_strong_color; set_color black --bold; end
  function set_normal_color; set_color normal; end
  function set_subtle_color; set_color white; end
  __prompt_context
  echo
else
  function set_strong_color; echo -n '#[fg=black,bold]'; end
  function set_normal_color; echo -n '#[default]'; end
  function set_subtle_color; echo -n '#[fg=white]'; end
  tmux set -q status-left (__prompt_context)
end


set functions -e set_strong_color
set functions -e set_normal_color
set functions -e set_subtle_color
set functions -e __prompt_context
set functions -e __prompt_context_pwd
set functions -e __prompt_context_git
